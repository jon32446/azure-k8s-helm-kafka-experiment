name: ACR # Azure Container Registry

# Trigger workflow on push to master in containers folder
on:
  push:
    branches:
      - master
    paths:
      - "containers/**"

jobs:
  build:
    runs-on: ubuntu-latest

    # Get those containers into ACR
    steps:
      - uses: actions/checkout@v2

      - name: Log into Azure
        run: az login --service-principal
          --username ${{ secrets.service_principal }}
          --password ${{ secrets.service_principal_password }}
          --tenant ${{ secrets.tenant }}

      - name: Build the Nginx image and save it to the container registry
        run: cd ~/containers/nginx-alpine &&
          az acr build
          --resource-group ppap-rg
          --registry ppapcr
          --file Dockerfile
          --image ppapcr/nginx-alpine:latest .

      - name: Build the Flask image and save it to the container registry
        run: cd ~/containers/uwsgi-server &&
          az acr build
          --resource-group ppap-rg
          --registry ppapcr
          --file Dockerfile
          --image ppapcr/uwsgi-server:latest .
